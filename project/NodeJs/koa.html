<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Koa | LoreFlows</title>
    <meta name="description" content="Welcome To The Knowledge Palace!">
    <link rel="icon" href="logo.ico">
    
    <link rel="preload" href="/BlogFlows/assets/css/0.styles.481dacda.css" as="style"><link rel="preload" href="/BlogFlows/assets/js/app.40814e45.js" as="script"><link rel="preload" href="/BlogFlows/assets/js/2.f4cb1acf.js" as="script"><link rel="preload" href="/BlogFlows/assets/js/41.10456487.js" as="script"><link rel="prefetch" href="/BlogFlows/assets/js/10.ef3b0305.js"><link rel="prefetch" href="/BlogFlows/assets/js/11.38947e9d.js"><link rel="prefetch" href="/BlogFlows/assets/js/12.8b23f1ea.js"><link rel="prefetch" href="/BlogFlows/assets/js/13.24ed00e3.js"><link rel="prefetch" href="/BlogFlows/assets/js/14.aae22bb5.js"><link rel="prefetch" href="/BlogFlows/assets/js/15.3b0cf42b.js"><link rel="prefetch" href="/BlogFlows/assets/js/16.8678c867.js"><link rel="prefetch" href="/BlogFlows/assets/js/17.bdfeb8b8.js"><link rel="prefetch" href="/BlogFlows/assets/js/18.ef671b42.js"><link rel="prefetch" href="/BlogFlows/assets/js/19.f00581ec.js"><link rel="prefetch" href="/BlogFlows/assets/js/20.2ba75e59.js"><link rel="prefetch" href="/BlogFlows/assets/js/21.66731536.js"><link rel="prefetch" href="/BlogFlows/assets/js/22.98d195b0.js"><link rel="prefetch" href="/BlogFlows/assets/js/23.e2de6496.js"><link rel="prefetch" href="/BlogFlows/assets/js/24.eba99031.js"><link rel="prefetch" href="/BlogFlows/assets/js/25.940fcbad.js"><link rel="prefetch" href="/BlogFlows/assets/js/26.396566fe.js"><link rel="prefetch" href="/BlogFlows/assets/js/27.1b426bcf.js"><link rel="prefetch" href="/BlogFlows/assets/js/28.c54b329d.js"><link rel="prefetch" href="/BlogFlows/assets/js/29.1d2b27d7.js"><link rel="prefetch" href="/BlogFlows/assets/js/3.d93bcbe1.js"><link rel="prefetch" href="/BlogFlows/assets/js/30.5163333a.js"><link rel="prefetch" href="/BlogFlows/assets/js/31.f028e790.js"><link rel="prefetch" href="/BlogFlows/assets/js/32.5ae5f7fc.js"><link rel="prefetch" href="/BlogFlows/assets/js/33.16d9b5f5.js"><link rel="prefetch" href="/BlogFlows/assets/js/34.73d6e4cb.js"><link rel="prefetch" href="/BlogFlows/assets/js/35.43fcd6c1.js"><link rel="prefetch" href="/BlogFlows/assets/js/36.f5632390.js"><link rel="prefetch" href="/BlogFlows/assets/js/37.546db6b1.js"><link rel="prefetch" href="/BlogFlows/assets/js/38.72d3a4b0.js"><link rel="prefetch" href="/BlogFlows/assets/js/39.4f2411ff.js"><link rel="prefetch" href="/BlogFlows/assets/js/4.605f48a5.js"><link rel="prefetch" href="/BlogFlows/assets/js/40.2806c4eb.js"><link rel="prefetch" href="/BlogFlows/assets/js/42.7ab57285.js"><link rel="prefetch" href="/BlogFlows/assets/js/43.f9cbcf2a.js"><link rel="prefetch" href="/BlogFlows/assets/js/44.53149759.js"><link rel="prefetch" href="/BlogFlows/assets/js/45.9cfccb3b.js"><link rel="prefetch" href="/BlogFlows/assets/js/46.86ee102e.js"><link rel="prefetch" href="/BlogFlows/assets/js/47.fa53f0e1.js"><link rel="prefetch" href="/BlogFlows/assets/js/48.2b0359d9.js"><link rel="prefetch" href="/BlogFlows/assets/js/5.deeb8ef3.js"><link rel="prefetch" href="/BlogFlows/assets/js/6.01480eef.js"><link rel="prefetch" href="/BlogFlows/assets/js/7.3965e4fd.js"><link rel="prefetch" href="/BlogFlows/assets/js/8.1ce9193f.js"><link rel="prefetch" href="/BlogFlows/assets/js/9.61a50a6d.js">
    <link rel="stylesheet" href="/BlogFlows/assets/css/0.styles.481dacda.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/BlogFlows/" class="home-link router-link-active"><!----> <span class="site-name">LoreFlows</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/BlogFlows/core/" class="nav-link">核心</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">工程</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/BlogFlows/project/" class="nav-link router-link-active">项目</a></li><li class="dropdown-item"><!----> <a href="/BlogFlows/normalize/" class="nav-link">规范</a></li><li class="dropdown-item"><!----> <a href="/BlogFlows/packages/" class="nav-link">类库</a></li></ul></div></div><div class="nav-item"><a href="/BlogFlows/concept/" class="nav-link">概念</a></div><div class="nav-item"><a href="/BlogFlows/tools/" class="nav-link">工具</a></div> <a href="https://github.com/yanGo1221" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/BlogFlows/core/" class="nav-link">核心</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">工程</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/BlogFlows/project/" class="nav-link router-link-active">项目</a></li><li class="dropdown-item"><!----> <a href="/BlogFlows/normalize/" class="nav-link">规范</a></li><li class="dropdown-item"><!----> <a href="/BlogFlows/packages/" class="nav-link">类库</a></li></ul></div></div><div class="nav-item"><a href="/BlogFlows/concept/" class="nav-link">概念</a></div><div class="nav-item"><a href="/BlogFlows/tools/" class="nav-link">工具</a></div> <a href="https://github.com/yanGo1221" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/BlogFlows/project/" class="sidebar-link">Overview</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Css</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/BlogFlows/project/Css/a.cluster.html" class="sidebar-link">Css</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>React</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/BlogFlows/project/React/a.redux.html" class="sidebar-link">Redux</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>TypeScript</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/BlogFlows/project/TypeScript/a.typescript.html" class="sidebar-link">TypeScript</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>HTML5</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/BlogFlows/project/HTML5/a.html5.html" class="sidebar-link">H5</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Swift</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/BlogFlows/project/Swift/a.cluster.html" class="sidebar-link">Cluster</a></li><li><a href="/BlogFlows/project/Swift/b.matters.html" class="sidebar-link">Matters</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="koa"><a href="#koa" aria-hidden="true" class="header-anchor">#</a> Koa</h1> <blockquote><p>koa 最大的特色，就是中间件的设计</p></blockquote> <p><a href="/BlogFlows/project/NodeJs/(https:/koa.bootcss.com/#application)">koa</a> 是一个 Web 框架，相比 express 框架，其通过利用 async 函数，能够有效解决 “回调地狱” 问题</p> <p><strong>Install</strong></p> <p>依赖 <strong>node v7.6.0</strong>，且对 async 函数方法支持，对于兼容问题可以通过 Babel 来实现 async 方法</p> <p><code>npm i koa</code> 安装 koa 框架</p> <p><code>npm init</code> 用来初始化项目，生成 package.json 文件</p> <p><strong>Travia</strong></p> <p><code>app.use(function)</code> 用来将中间件方法添加到应用程序</p> <p><code>next</code> 是中间件流程关键标志变量，<code>yeild next</code> 表示执行下一个中间件</p> <p><strong>Basics</strong></p> <p>Koa 提供一个 context 对象，用来装载请求的上下文，包括http请求和http回复，即 ctx.request, ctx.response</p> <p><code>app.context</code> 为 ctx 创建的原形，可以通过编辑 <code>app.context</code> 来为 ctx 添加其他属性</p> <p>Koa 默认返回类型是 <code>text/plain</code></p> <ul><li>返回之前通过 <code>ctx.request.accepts</code> 判断客户端接受类型</li> <li>然后通过 <code>ctx.response.type</code> 来指定返回类型，可选的 type 有：xml, json, html, text</li></ul> <h2 id="获取请求参数"><a href="#获取请求参数" aria-hidden="true" class="header-anchor">#</a> 获取请求参数</h2> <p>通过 <code>koa-bodyparser</code> 来解析 post 请求，将请求参数置于 <code>ctx.request.body</code> 内</p> <p>通过 <code>ctx.request.query</code> 可以直接获取 get 请求参数</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> BodyParser <span class="token keyword">from</span> <span class="token string">&quot;koa-bodyparser&quot;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">BodyParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ...view.js</span>
<span class="token keyword">import</span> Router <span class="token keyword">from</span> <span class="token string">&quot;koa-router&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 声明一个 router 实例</span>
<span class="token keyword">const</span> programRouter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

programRouter<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/program/overview'</span><span class="token punctuation">,</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> params <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'json'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// statement</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

programRouter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/program/get'</span><span class="token punctuation">,</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> params <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
    <span class="token comment">// statements</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h2 id="错误捕获"><a href="#错误捕获" aria-hidden="true" class="header-anchor">#</a> 错误捕获</h2> <p>Koa 提供 <code>ctx.throw()</code> 或者 <code>ctx.response.status = 400</code> 用来抛出错误，但是更常用的是通过 koa 提供 <code>app.on('error', (err, ctx) =&gt; {})</code> 监听方法来集中式捕获错误</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">listenError</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    app<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 将可能出现的单引号替换为中文全角单引号，避免 sql 错误</span>
            <span class="token keyword">const</span> errStr <span class="token operator">=</span> <span class="token function">String</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\'/g</span><span class="token punctuation">,</span> <span class="token string">'‘'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 自定义错误捕获内容</span>
            <span class="token keyword">let</span> params <span class="token operator">=</span> <span class="token punctuation">{</span>
                username<span class="token punctuation">:</span> <span class="token string">'yh'</span><span class="token punctuation">,</span>
                project<span class="token punctuation">:</span> <span class="token string">'YLONELY_GROWUP-koa'</span><span class="token punctuation">,</span>
                referrer<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
                event<span class="token punctuation">:</span> <span class="token string">'koa-error'</span><span class="token punctuation">,</span>
                type<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
                path<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>originalUrl<span class="token punctuation">,</span>
                level<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                stack<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
                message<span class="token punctuation">:</span> errStr<span class="token punctuation">,</span>
                origin<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
                useragent<span class="token punctuation">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>app<span class="token punctuation">)</span><span class="token punctuation">,</span>
                network<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
                appversion<span class="token punctuation">:</span> <span class="token string">''</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token comment">// 对错误类型进行分类</span>
            <span class="token comment">// 请求参数错误</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>errStr<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'ValidationError'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                params<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'ValidationError'</span><span class="token punctuation">;</span>
                params<span class="token punctuation">.</span>origin <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>details<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 函数方法错误</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>errStr<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'TypeError'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                params<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'TypeError'</span><span class="token punctuation">;</span>
                params<span class="token punctuation">.</span>stack <span class="token operator">=</span> err<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\'/g</span><span class="token punctuation">,</span> <span class="token string">'‘'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
                <span class="token comment">// sql 语句错误</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>errStr<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'SequelizeDatabaseError'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                params<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'SequelizeDatabaseError'</span><span class="token punctuation">;</span>
                params<span class="token punctuation">.</span>stack <span class="token operator">=</span> err<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\'/g</span><span class="token punctuation">,</span> <span class="token string">'‘'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">addErrorsRecord</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><h2 id="执行python脚本"><a href="#执行python脚本" aria-hidden="true" class="header-anchor">#</a> 执行python脚本</h2> <p>使用的相关模块方法</p> <ul><li>util</li> <li>child_progress</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// import 方法基于 babel 实现使用</span>
<span class="token keyword">import</span> util <span class="token keyword">from</span> <span class="token string">'util'</span><span class="token punctuation">;</span>

<span class="token comment">// 通过 util.promisify 来实现异步，其返回一个 promise 对象</span>
<span class="token keyword">const</span> exec <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">promisify</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>exec<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 执行 python 脚本，更新 wakatime
 * @param {start} params 开始时间
 * @param {end} params 结束时间
 */</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">setWakaTime</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> label <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> cmd <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">python3 scripts/wakatime/wakatime.py </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>params<span class="token punctuation">.</span>start<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>params<span class="token punctuation">.</span>end<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> False</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token comment">// stderr 获取错误信息</span>
        <span class="token comment">// stdout 获取返回信息，即 python 脚本内 return 的数据</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> stdout<span class="token punctuation">,</span> stderr <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">exec</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stdout <span class="token operator">!==</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">stderr: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>stderr<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            label <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> label<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h2 id="koa-route"><a href="#koa-route" aria-hidden="true" class="header-anchor">#</a> koa route</h2> <p>如果原生的 node，可以通过判断 <code>ctx.path</code> 来控制路由，进行不同的处理，但是，koa提供了一个更好的方式：通过 koa 封装的路由中间件来实现路由</p> <p>通过 <code>const Router = require('koa-router')</code> 来引入koa路由中间件，其方法包括：get, post, del, put, all</p> <p><code>all()</code> 表示适用所有的动词方法</p> <p>通过 <code>'/details/:id'</code> 这样的通配规则来匹配 get 请求， <code>ctx.params</code> 来获取路由参数</p> <p>通过 <code>app.params()</code> 方法可以将参数的处理给抽象出来，起到一定的安全防范作用</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> Router <span class="token keyword">from</span> <span class="token string">'koa-router'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Compose <span class="token keyword">from</span> <span class="token string">'koa-compose'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> errorRouter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 捕获错误，插入数据库
 */</span>
errorRouter<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/catchErrors'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// statements</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/service/system'</span><span class="token punctuation">,</span> errorRouter<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> errorRouter<span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> router_middle <span class="token operator">=</span> router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> router_allow_methods <span class="token operator">=</span> router<span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> errorCompose <span class="token operator">=</span> <span class="token function">Compose</span><span class="token punctuation">(</span><span class="token punctuation">[</span>router_middle<span class="token punctuation">,</span> router_allow_methods<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> errorCompose<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">11/18/2019, 3:29:12 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/BlogFlows/assets/js/app.40814e45.js" defer></script><script src="/BlogFlows/assets/js/2.f4cb1acf.js" defer></script><script src="/BlogFlows/assets/js/41.10456487.js" defer></script>
  </body>
</html>
