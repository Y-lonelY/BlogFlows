# æ·±å…¥æµ…å‡º Webpack

> Smaller, Faster,  Modules

è¿™æ˜¯ä¸€ç¯‡è¯»ä¹¦ç¬”è®°, è®°å½•æˆ‘åœ¨é˜…è¯»**æ·±å…¥æµ…å‡º Webpack**å’Œ**Webpack å®˜æ–¹æ–‡æ¡£**è¿‡ç¨‹ä¸­çš„æ‰€å­¦æ‰€æ€ğŸ”¥


## æ¨¡å—åŒ–

> Module is the future!

å¯¹äºç°åœ¨çš„ Web åº”ç”¨æ¥è¯´, æ¨¡å—åŒ–æ˜¯ä¸€ä¸ªç»•ä¸å¼€çš„è¯é¢˜. **æ¨¡å—åŒ–æ˜¯æŒ‡å°†ä¸€ä¸ªå¤æ‚çš„ç³»ç»Ÿåˆ†è§£ä¸ºå¤šä¸ªæ¨¡å—ä»¥æ–¹ä¾¿ç¼–ç , ç®€å•æ¥è¯´å°±æ˜¯: è¾“å…¥/è¾“å‡ºä»£ç å—**

åœ¨ jQuery çš„é‚£ä¸ªæ—¶ä»£, å¤§å¤šæ•°çš„è„šæœ¬éƒ½æ˜¯å°†å…¶ API æŒ‚è½½åˆ°å…¨å±€å‘½åç©ºé—´ï¼ˆæ¯”å¦‚ `window.$`ï¼‰ä¸‹, ä»¥åœ¨ä¸åŒæ–‡ä»¶å†…è¿›è¡Œå¼•ç”¨.

ç°åœ¨å›è¿‡å¤´æ¥æ€è€ƒä¸€ä¸‹, è¿™æ ·çš„åšæ³•ä¼šå¸¦æ¥ä¸€äº›é—®é¢˜

- æ— æ³•åˆç†åœ°ç®¡ç†é¡¹ç›®çš„ä¾èµ–å’Œç‰ˆæœ¬ï¼ˆå‘½åç©ºé—´å†²çªçš„é—®é¢˜ï¼‰
- æ— æ³•æ–¹ä¾¿åœ°æ§åˆ¶ä¾èµ–çš„åŠ è½½é¡ºåº

å½“é¡¹ç›®çš„ä¾èµ–å¢å¤šæˆ–è€…å‰ç«¯é¡¹ç›®å˜å¤§æ—¶, è¿™ç§æ–¹å¼è¶Šæ¥è¶Šéš¾ä»¥ç»´æŠ¤, äºæ˜¯æœ‰äº†æ¨¡å—çš„ä¸€äº›è§£å†³æ–¹æ¡ˆ

è¿™é‡Œä»…é’ˆå¯¹ JavaScript å†…çš„æ¨¡å—åŒ–æ–¹æ¡ˆè¿›è¡Œä»‹ç», è¿˜æœ‰å…³äºæ ·å¼çš„æ¨¡å—åŒ–æ–¹æ¡ˆ, æ¯”å¦‚ `less` ç­‰, è¿™é‡Œå°±ä¸å†è¿›èµ˜è¿°, ç›®çš„æ˜¯ä¸ºäº†è®©ä½ èƒ½å¤Ÿæ„ŸçŸ¥åˆ°: 

**æˆ‘ä»¬å°è£…äº†å¾ˆå¤šè½®å­, æ¥ä½¿æˆ‘ä»¬æ›´é«˜æ•ˆçš„ç¼–ç , ä½†æ˜¯å¾€å¾€éœ€è¦ç¼–è¯‘åçš„ä»£ç æ‰èƒ½æ¥è®©æœºå™¨æ‰§è¡Œ**



### CommonJS

éšç€ NodeJS çš„æµè¡Œ, è¿™ç§æ¨¡å—åŒ–æ–¹æ¡ˆè¢«å‘æ‰¬å…‰å¤§, å…¶æ ¸å¿ƒæ€æƒ³æ˜¯**é€šè¿‡ `require` æ–¹æ³•æ¥åŒæ­¥åŠ è½½(è¾“å…¥)ä¾èµ–, é€šè¿‡ `module.exports` æ¥è¾“å‡ºä»£ç å—**

CommonJS é€šå¸¸è¢«ç”¨æ¥åœ¨éæµè§ˆå™¨ç«¯ç®¡ç†ä¾èµ–ï¼Œè®¾è®¡ç›®çš„æ˜¯é¿å…æ¨¡å—å®šä¹‰å…¨å±€å¯¹è±¡.

**åœ¨ CommonJS å†…ï¼Œä¸€ä¸ªæ–‡ä»¶å°±æ˜¯ä¸€ä¸ªæ¨¡å—**

å¯ä»¥ç›´æ¥åœ¨ NodeJS ç¯å¢ƒä¸‹è¿è¡Œ, ä½†æ˜¯æ— æ³•ç›´æ¥åœ¨æµè§ˆå™¨ç¯å¢ƒä¸‹è¿è¡Œ, éœ€è¦è½¬æ¢æˆæ ‡å‡† ES5 



### AMD

**AMD(Asynchronous Module Definition)** é¡¾åæ€ä¹‰, å®ƒé‡‡ç”¨å¼‚æ­¥çš„æ–¹å¼æ¥åŠ è½½ä¾èµ–çš„æ¨¡å—, jQuery æ—¶ä»£é‡Œ, [requirejs](https://requirejs.org/) å°±æ˜¯å…¶å…¸å‹ä»£è¡¨.

çœ‹ä¸€ä¸ªä½¿ç”¨ `requirejs` çš„ä¾‹å­ï¼š

```javascript
// defined a module
define('jquery', function(jq) {
  return jq.noConflict(true)
})

// require a moduel
require(['jquery'], function($) {
  console.log($)
})
```

å…¶ä¼˜åŠ¿åœ¨äº

- å¯ä»¥ç›´æ¥åœ¨æµè§ˆå™¨ç¯å¢ƒæˆ–è€… NodeJS ç¯å¢ƒä¸‹è¿è¡Œ
- å¯ä»¥å¼‚æ­¥åŠ è½½ä¾èµ–
- å¯ä»¥å¹¶è¡ŒåŠ è½½å¤šä¸ªä¾èµ–

ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾, å°±æ˜¯éœ€è¦å¼•å…¥ç¬¬ä¸‰æ–¹ä¾èµ–æ¥å®ç°



### ES6 module

è¿™åº”è¯¥æ˜¯å¤§å®¶éå¸¸ç†Ÿæ‚‰çš„, ç°ä»£æ¡†æ¶éƒ½æ˜¯æ”¯æŒçš„æ¨¡å—åŒ–æ–¹æ¡ˆ, ä½†æ˜¯å®ƒä¹Ÿæ— æ³•åœ¨ NodeJS å’Œæµè§ˆå™¨ç¯å¢ƒä¸‹ç›´æ¥è¿è¡Œ

- ä¸€ä¸ªæ–‡ä»¶å°±æ˜¯ä¸€ä¸ªæ¨¡å—ï¼Œä¸æ”¯æŒæŒ‰éœ€åŠ è½½
- ES6 æ¨¡å—æ˜¯é™æ€çš„ï¼Œå³å¯¼å…¥åæ— æ³•è¿›è¡Œæ›´æ”¹
- ES6 æ˜¯æŒ‡é’ˆç»‘å®šï¼Œåœ¨ç¼–è¯‘æ—¶è¾“å‡ºï¼Œä¸åŒäº CommonJS å€¼ç»‘å®šï¼Œæ¨¡å—å†…åšå‡ºäº†ä¿®æ”¹ï¼Œä¼šåæ˜ åˆ°æ‰€æœ‰ä½¿ç”¨è¯¥æ¨¡å—çš„ä»£ç ä¸­
- ES6æ¨¡å—é‡‡ç”¨çš„æ˜¯å•ä¾‹æ¨¡å¼ï¼Œæ¯æ¬¡å¯¹åŒä¸€ä¸ªæ¨¡å—çš„å¯¼å…¥å…¶å®éƒ½æŒ‡å‘åŒä¸€ä¸ªå®ä¾‹



## æ„å»º

å‰ç«¯æ„å»ºåˆ°åº•æ˜¯æ€ä¹ˆä¸€å›äº‹å‘¢ï¼Ÿæˆ‘ä»¬ä¸å¦¨ä» [webpack](https://www.webpackjs.com/) çš„å®˜ç½‘ä¸Šä¸€çª¥ç©¶ç«Ÿ

![webpack](../assets/webpack.png)

**å‰ç«¯æ„å»ºè¦åšçš„å°±æ˜¯å°†å„ä¸ªæ¥æºçš„èµ„æºï¼ˆè„šæœ¬æ–‡ä»¶ä¹Ÿæ˜¯èµ„æºï¼‰è½¬æ¢æˆå¯æ‰§è¡Œçš„ JavaScript, HTML, CSS ä»£ç **

- ä»£ç è½¬æ¢, æ¯”å¦‚ TypeScript -> JavaScript, less/sass/scss -> css
- æ–‡ä»¶ä¼˜åŒ–, å³æ–‡ä»¶å‹ç¼©
- ä»£ç åˆ†å‰²
- æ¨¡å—åˆå¹¶, å°†å¤ç”¨æ¨¡å—åˆå¹¶åˆ°åŒä¸€ä¸ªæ–‡ä»¶å†…
- è‡ªåŠ¨åˆ·æ–°, ç›‘å¬æ–‡ä»¶å˜åŒ–, é‡æ–°æ„å»ºå¹¶åˆ·æ–°æµè§ˆå™¨é¡µé¢
- è‡ªåŠ¨å‘å¸ƒ



## Webpack Main Config

è¿™é‡Œæˆ‘ä¼šå¯¹ä¸€äº›é‡è¦çš„é…ç½®å±æ€§è¿›è¡Œä»‹ç», å¦‚æœ‰å¿…è¦ä¼šé’ˆå¯¹æ€§çš„è¿›è¡Œæ·±å…¥åˆ†æ

å…ˆæ¥çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­

```javascript
const path = require('path')

module.exports = {
  entry: './src/index.js',
  // to define the output file path and name
  // with NodeJS core module path
  output: {
    path: path.resolve(__dirname, 'dist'),
    filename: 'bundle.js'
  },
  // loaders to support file compiler
  // compiling form right to left 
  module: {
    rules: [
      {
        test: /\.css$/,
        // like get request to transfer params
        use: ['style-loader', 'css-loader']
      }
    ]
  }
}
```



è¿™é‡Œåˆ—ä¸¾äº† webpack çš„æ ¸å¿ƒæ¦‚å¿µ

- **Entry**: Webpack æ‰§è¡Œæ„å»ºä»»åŠ¡çš„å…¥å£
- **Module**: æ¨¡å—æ˜¯ Webpack å†…çš„æ ¸å¿ƒæ¦‚å¿µ, ä¸€ä¸ªæ–‡ä»¶å¯¹åº”ä¸€ä¸ªæ¨¡å—, Webpack ä¼šæ ¹æ®å…¥å£é€’å½’æŸ¥æ‰¾å‡ºæ‰€æœ‰æ¨¡å—çš„é€’å½’å…³ç³»
- **Chunk**: ä¸€ä¸ªä»£ç å—ç”±å¤šä¸ªæ¨¡å—æ„æˆ, ç”¨äºä»£ç åˆ†å‰².
- **Output**: è¾“å‡ºå†…å®¹
- [loaders ä»£ç è½¬æ¢å™¨](./loaders.md)
- [plugin æ‰©å±•æ’ä»¶](./plugins.md)

é™¤æ­¤ä¹‹å¤–, è¿˜æœ‰ä¸€äº›é…ç½®æ˜¯ç”¨æ¥â€œæœåŠ¡â€ä¸Šè¿°æ ¸å¿ƒæ¦‚å¿µ, æˆ‘ä»¬ä¹Ÿå¯¹å…¶è¿›è¡Œç†è§£

- **Resolve**: å¦‚ä½•å¯»æ‰¾æ¨¡å—æ‰€å¯¹åº”çš„æ–‡ä»¶
- [optimization ä¼˜åŒ–é¡¹](./optimization.md)


### Entry

`entry` æ”¯æŒé…ç½®**å¤šä¸»å…¥å£**

> This is useful when you would like to inject multiple dependent files together and graph their dependencies into one chunk.

é™¤äº†æ”¯æŒ string å¤–, è¿˜å¯ä»¥é€šè¿‡åˆ—è¡¨æˆ–è€…å¯¹è±¡çš„å½¢å¼ä¸ºå…¶é…ç½®å…¥å£

- Entry ç±»å‹ä¸º `string` æˆ–è€… `array`, åˆ™åªä¼šç”Ÿæˆä¸€ä¸ª chunk, ä¸”åå­—ä¸º `main`
- Entry ç±»å‹ä¸º `object`, åˆ™ä¼šç”Ÿæˆå¤šä¸ª chunk, æ¯ä¸ª chunk åå­—ä¸ºå…¶**é”®å€¼**

```javascript
module.exports = {
  // string -> main.js
  entry: './src/index.js',
	// array -> main.js
  entry: [
    './src/app1/index.js',
    './src/app2/index.js'
  ],
  // object -> app1.js, app2.js
  entry: {
    app1: './src/app1/index.js',
    app2: './src/app2/index.js'
  }
}
```



### Resolve

Webpack é€šè¿‡ `entry` æ¥è§£å†³æ–‡ä»¶å…¥å£çš„é—®é¢˜, `resolve` åˆ™æ˜¯ç”¨ç±»ä¼¼**çº¦å®š**çš„æ–¹å¼, åœ¨æ¨¡å—å†…å¯»æ‰¾æ¨¡å—æ‰€å¯¹åº”çš„æ–‡ä»¶

åœ¨å¼€å‘è¿‡ç¨‹ä¸­, æˆ‘ä»¬ç»å¸¸ä¼šç”¨ `import React from 'React'`, `import renderCell from '@/components/cell-render'` ç­‰å„ç§ç±»ä¼¼â€œä»£ç†â€çš„æ–¹å¼æ¥å¼•å…¥æ¨¡å—, æ­¤æ—¶ webpack å°±æ˜¯é€šè¿‡ **resolve** é…ç½®é¡¹æ¥å¯»æ‰¾åˆ°ç›¸åº”çš„æ¨¡å—

é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥çœ‹çœ‹å¸¸ç”¨çš„å±æ€§é…ç½®:

```javascript
  resolve: {
    // alias é€šè¿‡åˆ«åæ¥æ˜ å°„ä¸€ä¸ªæ–°çš„å¯¼å…¥è·¯å¾„
    alias: {
      '@': './src',
      'components': './src/components'
    },
    // mainFields ç”¨æ¥æŒ‡å®šé€‚é…ç¯å¢ƒçš„ä»£ç åŠ è½½é¡ºåº
    mainFields: ["broswer", "main"],
    // extensions ç”¨æ¥è¡¥å…¨åç¼€, å¹¶æŒ‡å®šè¡¥å…¨åç¼€å¹¶åŒ¹é…çš„ä¼˜å…ˆçº§
    extensions: [".ts", ".js", ".json"]
  },
```



<b style="color: #ef613e;">mainFields</b>

â€‹		ä¸€äº›ç¬¬ä¸‰æ–¹åº“ä¼šæ ¹æ®ç¯å¢ƒæä¾›å¤šä»½ä»£ç , æ¯”å¦‚ `rollup` æ‰“åŒ…æ—¶å¯ä»¥åŒæ—¶è¾“å‡º `commonjs` å’Œ `ES6` çš„ä»£ç , webpack ä¼šæ ¹æ® mainFields æ¥å†³å®šä»£ç çš„ä½¿ç”¨é¡ºåº, å®ƒä¼šæŒ‰ç…§æ•°ç»„çš„é¡ºåºå» **package.json** å†…è¿›è¡Œå¯»æ‰¾, åŒ¹é…åˆ°ç«‹å³è¿”å›

<b style="color: #ef613e;">extensions</b>

â€‹		ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„å±æ€§, Ryan åœ¨ deno å‘å¸ƒä¼šä¸Šå…¬å¼€ diss äº†è¿™ä¸ªè®¾è®¡(å³è‡ªåŠ¨åŒ¹é… index, è‡ªåŠ¨è¡¥å…¨ .js), extensions ç”¨æ¥é…ç½®è¡¥å…¨çš„åç¼€å’Œåç¼€çš„åŒ¹é…é¡ºåº, æ¯”å¦‚ `import App from './app'` , åœ¨é»˜è®¤é…ç½®ä¸‹, å°±ä¼šä¼˜å…ˆå»åŒ¹é… `app.js`, å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°å°±ç»§ç»­åŒ¹é… `app.json`


### Output

**output** ç”¨æ¥å‘Šè¯‰ Webpack å¦‚ä½•åœ¨ç£ç›˜ä¸Šå†™å…¥æœ€ç»ˆè¾“å‡ºçš„æ–‡ä»¶, é…ç½®ç±»å‹ä¸º object

```javascript
output: {
  path: path.resolve(__dirname, 'dist'),
  // [name] will add filename
  filename: '[name].bundle.js',
  publicPath: 'https://7k7k.life/assets/'
},
```



- `path` è¾“å‡ºæ–‡ä»¶å­˜æ”¾çš„ç›®å½•, æ˜¯ä¸€ä¸ª**ç»å¯¹è·¯å¾„**, é€šå¸¸é€šè¿‡ `path.resolve(__dirname, 'path')` æ¥å®šä¹‰
- `filename` è¾“å‡ºæ–‡ä»¶çš„åå­—, æ”¯æŒæ¨¡ç‰ˆå­—ç¬¦ä¸², å½“ entry é…ç½®ä¸ºå¤šå…¥å£æ—¶, éœ€è¦ä½¿ç”¨æ¨¡ç‰ˆè¯­æ³•æ¥ç¡®ä¿æ¯ä¸ªè¾“å‡ºæ–‡ä»¶æœ‰**å”¯ä¸€çš„åå­—**

| å˜é‡å                                            | å«ä¹‰                                 |
| :------------------------------------------------ | ------------------------------------ |
| id                                                | Chunk çš„å”¯ä¸€æ ‡è¯†ï¼Œä»0å¼€å§‹            |
| name                                              | Chunk çš„åç§°                         |
| hash, æ¯”å¦‚ `[hash:8]` è¡¨ç¤ºå–8ä½ hash å€¼           | Chunk çš„å”¯ä¸€æ ‡è¯†çš„ Hash å€¼           |
| chunkhash                                         | Chunk å†…å®¹çš„ Hash å€¼, ç”±ä¸€ç»„æ¨¡å—ç»„æˆ |
| contenthash, éœ€è¦ `ExtractTextWebpackPlugin` æ’ä»¶ | ä»£ç å†…å®¹æœ¬èº«ç»„æˆçš„ Chunk             |

- `publicPath` ç”¨æ¥é…ç½®èµ„æºæ–‡ä»¶çš„è·¯å¾„, æ¯”å¦‚ä½ æœ‰ä¸€ä¸ªå›¾ç‰‡æœåŠ¡å™¨, åœ°å€ä¸º `https:www.images.com/assets/`, æ­¤æ—¶å¯ä»¥é…ç½® `output.publicPath:https:www.images.com/assets/ `, å®ƒä¼šå‘Šè¯‰ Webpack, åœ¨ç¼–è¯‘çš„æ—¶å€™ç¢°åˆ°å¼•ç”¨è¯¥åœ°å€çš„èµ„æºæ–‡ä»¶, ä½ ä¸ç”¨è¿›è¡Œæ„ŸçŸ¥, å¹¶ä¸”è¿™ä¸ªå±æ€§æ”¯æŒåœ¨å…¥å£æ–‡ä»¶é€šè¿‡ `__webpack_public_path__ = PublicPath` æ¥è¿›è¡ŒåŠ¨æ€é…ç½®



### Chunk

ä¸€ä¸ª **chunk** ç”±å¤šä¸ª module ç»„æˆ, ç”¨äºä»£ç åˆ†å‰²å’Œåˆå¹¶

**ä¸€ä¸ª entry å’Œå…¶æ‰€æœ‰ä¾èµ–çš„ Modules ç»„æˆä¸€ä¸ª chunk**

ä¸¾ä¸ªä¾‹å­: åœ¨ webpack 4 ä¹‹å‰, é€šå¸¸å°†ä¸€äº›ä¸ä¼šå†æ”¹å˜çš„è„šæœ¬(æ¯”å¦‚ `JQuery, Bootstrap` ç­‰)æ”¾åˆ°ä¸€ä¸ª chunk å†…(é€šå¸¸æ˜¯ `vendor.js`), è¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†è®©æµè§ˆå™¨ç¼“å­˜è¿™äº›è„šæœ¬, ä»è€Œå‡å°‘åŠ è½½æ—¶é—´

**webpack 4 ä¹‹åé€šè¿‡ optimization.splitChunks å±æ€§æ¥é…ç½®, è¿›è¡Œä»£ç åˆ†å‰²**



## Webpack Else Config

è¿™é‡Œä»‹ç»ä¸€äº›å¸¸ç”¨çš„, ä½†æ˜¯æ²¡é‚£ä¹ˆé‡è¦çš„é…ç½®é¡¹

### Target

**Target** ç”¨æ¥æ§åˆ¶ webpack æ„å»ºå‡ºé’ˆå¯¹ä¸åŒç¯å¢ƒçš„ä»£ç 

### Devtool

**Devtool** æ§åˆ¶ webpack å¦‚ä½•ç”Ÿæˆ Source Map, é»˜è®¤å€¼ä¸º `false`, å¦‚æœåœ¨å¼€å‘æ—¶å¸Œæœ›ç”Ÿæˆ source map æ¥è¿›è¡Œè°ƒè¯•, å¯ä»¥è®¾ç½® `{ devtool: 'source-map'}`

### Watch

**Watch** æ§åˆ¶ webpack æ˜¯å¦å¼€å¯ç›‘å¬æ¨¡å¼, å¼€å¯ç›‘å¬æ¨¡å¼ä¹‹å, webpack ä¼šç›‘å¬æ–‡ä»¶çš„å˜åŒ–, åœ¨æ–‡ä»¶å‘ç”Ÿå˜åŒ–æ—¶é‡æ–°ç¼–è¯‘, è®¾ç½® `{ watch: true }`

ä½¿ç”¨ `DevServer` æ—¶, é»˜è®¤å¼€å¯, é€šè¿‡ `watchOptions` æ¥è¿›è¡Œæ›´åŠ çµæ´»çš„è®¾ç½®

```javascript
  watchOptions: {
    // ä¸ç›‘å¬çš„æ–‡ä»¶
    ignored: /node_modules/,
    // ç›‘å¬åˆ°å˜åŒ–åˆ°äº§ç”ŸåŠ¨ä½œçš„å»¶è¿Ÿ, é˜²æ­¢æ›´æ–°é¢‘ç‡å¤ªé«˜
    aggregateTimeout: 300,
    // ä¸»åŠ¨è½®è®­, æ¯ 1000 æ¯«ç§’åˆ¤æ–­ä¸€æ¬¡
    poll: 1000
  }
```

