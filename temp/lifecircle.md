# Page Lifecircle

在系统资源受限时，浏览器往往会暂停或者丢弃页面。将来，浏览器希望主动地来做这件事情（即主动识别到资源的消耗，从而采取相应的措施）来降低电量和内存的消耗。[Page Lifecycle API](https://wicg.github.io/page-lifecycle/) 通过提供一系列的生命周期钩子来使你更加安全地处理浏览器干预措施，并且降低对用户体验的影响。

## Background

应用生命周期是现代操作系统用来管理资源的关键方式。在 Android, IOS, Windows 系统内，系统可以随时开启/终止应用。系统通过对资源的简化和重新分配，从而达到极致的用户体验。

但是在 web 端，历史上没有这样的生命周期管理，web app 能够一直保持运行状态。过多的 web 应用就会导致系统资源，比如 CPU, 内存, 电量以及网络被过度消费，从而影响整个系统的使用体验。

虽然浏览器在很久之前就已经实现了类似生命周期钩子的状态，比如 `onload`, `unload` 以及 `visibilitychange` -- 但是这些事件仅能够让开发者去响应用户发起的状态更改（比如打开/关闭/切换 web 应用）。为了让 web app 能够在低功耗设备更加可靠地运行（或者说是在所有平台上能够更加关心资源消耗），浏览器需要一个方式来主动回收和重新分配系统资源。

实际上，浏览器已经采取了很多措施来节省后台标签中页面的资源消耗，许多浏览器希望做更多的事情来减少系统总体资源的消耗。

问题就是，开发者无法感知到系统发起的状态改变（即对资源的处理）

Page Lifecycle API 用来解决以下问题：

1. 引入/标准化 Page Lifecircle 的状态和概念
2. 定义新的系统态，允许浏览器限制 tab 在隐藏或者激活时可能占用的系统资源
3. 创建新的 API 和 event 来让开发者响应系统态的状态变化

## Overview

所有页面生命周期状态都是离散和相互独立的，这就意味着页面在某个时刻只能存在某一种状态。并且大多数的页面生命周期状态变化都可以通过 DOM 事件观测到。

## States

1. Active: 页面可见并且聚焦
2. Passive: 页面可见但是不聚焦
3. Hidden: 页面不可见并且没有被冻结，前一个状态一定是 Passive
4. Frozen: 
   - 冻结状态下，浏览器会停止执行页面事件队列中的可冻结任务， 直到页面解冻为止。这就意味着 JavaScript 内的定时器任务，请求等都不会继续执行。已经在执行中的任务可以继续执行，但是会限制其作用范围和执行时间。
   - 浏览器通过冻结页面来保留CPU/电池/数据使用量，使浏览器能够以更快的速度响应诸如前进/后退的事件 -- 而不需要重新加载整个页面
   - 前一个状态一定是 Hidden，通过 `freeze` 事件触发
5. Terminated: 
   - 一旦页面开始被浏览器卸载并且将其从内存中进行清理时，页面就处于终止状态。在终止状态下，新的任务不会被执行，已经在执行中的任务，如果其执行时间太长会被强制终止掉
   - 前一个状态一定是 Hidden，通过 `pagehide` 事件触发
6. Discarded: 
   - 当页面被浏览器完全卸载时，它将处于废弃状态。该页面内不会再执行任何事件。
   - 在废弃状态下，tab 的标题和 icon 通常还会保留
   - 前一个状态一定是 Frozen

## Events

浏览器提供的和页面生命周期相关的事件类型

1. focus: 如果页面之前处于失焦状态，则发出状态改变
2. blur: 如果页面不再聚焦，则发出状态改变
3. visibilitychange: 文档对象的 visibilityState 改变。常见的场景是：用户打开一个新页面，切换 tab，关闭 tab，最小化或者关闭浏览器，或者在手机上切换 APP。
4. freeze: 页面刚刚被冻结，页面任务队列中的任何可冻结任务都不会被执行
5. resume: 页面从冻结状态下恢复
6. pageshow: 会话历史记录条目被遍历到。可以是打开一个全新的页面，或者是从页面缓存内加载一个已有页面。如果是从缓存内获取页面内容，则 `persisted` 属性为 true
7. pagehide: 如果用户导航到其他页面，同时浏览器能够将当前页面添加到页面缓存内，则事件的 `persisted` 属性为 true，该页面进入冻结状态，否则页面进入终止状态
8. beforeunload: 
   - window, document 和页面资源即将被卸载，此时页面仍然可见，并且可以取消该事件
   - 该事件应该仅被用来提醒用户有未保存的改动
9. unload: 该页面正在被卸载，不建议使用该事件，因为它不可靠，并且在某些情况下会损害性能

